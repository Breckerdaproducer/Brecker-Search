<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brecker Search - AI Search Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Söhne:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Söhne', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        .typing-indicator {
            display: inline-block;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: #10a37f;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 1px;
        }

        .typing-indicator:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .dark-mode-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem;
            border-radius: 9999px; /* Makes it a circle */
            background-color: rgba(0, 0, 0, 0.1); /* Slightly transparent background */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease-in-out;
            color: #ccc; /* Light grey for icon */
        }

        .dark-mode-toggle:hover {
            background-color: rgba(0, 0, 0, 0.2);
        }

        .dark .dark-mode-toggle {
            background-color: rgba(255, 255, 255, 0.1);
            color: #eee;
        }

        .dark .dark-mode-toggle:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .hidden {
            display: none !important;
        }

        /* Styles for scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .dark ::-webkit-scrollbar-track {
            background: #333;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #666;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-chatgpt-dark-bg dark:text-gray-100 flex h-screen overflow-hidden">
    <div class="dark-mode-toggle" onclick="toggleDarkMode()">
        <i class="fas fa-moon"></i>
    </div>

    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-chatgpt-dark-bg p-6 rounded-lg shadow-xl w-80">
            <h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-100" id="confirmModalTitle">Confirm Action</h3>
            <p class="text-gray-700 dark:text-gray-300 mb-6" id="confirmModalMessage">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeConfirmModal()" class="px-4 py-2 rounded-lg text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-700 transition duration-200">Cancel</button>
                <button id="confirmModalButton" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition duration-200">Confirm</button>
            </div>
        </div>
    </div>

    <div id="sidebar" class="w-64 bg-gray-200 dark:bg-chatgpt-dark-sidebar-bg p-4 flex flex-col justify-between transition-transform duration-300 ease-in-out">
        <div>
            <button onclick="startNewChat()" class="w-full mb-4 py-3 px-4 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold hover:from-blue-600 hover:to-purple-700 transition-all duration-200 shadow-md flex items-center justify-center">
                <i class="fas fa-plus mr-2"></i> New Brecker Chat
            </button>
            <div id="chatHistory" class="space-y-2 overflow-y-auto max-h-[calc(100vh-200px)] scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-300 dark:scrollbar-thumb-gray-600 dark:scrollbar-track-gray-700">
                </div>
        </div>
        <div class="mt-4 border-t border-gray-300 dark:border-gray-700 pt-4">
            <div id="storageInfo" class="text-xs text-gray-600 dark:text-gray-400 mb-2">
                </div>
            <button onclick="clearAllConversations()" class="w-full text-left py-2 px-3 rounded-lg text-red-500 hover:bg-gray-300 dark:hover:bg-gray-700 transition duration-200 flex items-center">
                <i class="fas fa-trash-alt mr-2"></i> Clear All Chats
            </button>
            <button onclick="exportConversations()" class="w-full text-left py-2 px-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-700 transition duration-200 flex items-center">
                <i class="fas fa-file-export mr-2"></i> Export Chats
            </button>
            <input type="file" id="importFileInput" class="hidden" accept=".json" onchange="importConversations(event)">
            <button onclick="document.getElementById('importFileInput').click()" class="w-full text-left py-2 px-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-700 transition duration-200 flex items-center">
                <i class="fas fa-file-import mr-2"></i> Import Chats
            </button>
        </div>
    </div>

    <div id="chatContainer" class="flex-1 flex flex-col relative">
        <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8 space-y-4 scrollbar-thin scrollbar-thumb-blue-400 scrollbar-track-blue-100 dark:scrollbar-thumb-blue-700 dark:scrollbar-track-blue-900">
            </div>

        <div class="p-4 md:p-6 lg:p-8 bg-gray-100 dark:bg-chatgpt-dark-bg border-t border-gray-200 dark:border-chatgpt-dark-border">
            <form id="searchForm" class="relative">
                <div class="relative flex items-center">
                    <textarea
                        id="searchInput"
                        rows="1"
                        placeholder="Ask Brecker Search anything..."
                        class="w-full py-4 pl-6 pr-14 bg-white dark:bg-chatgpt-dark-input-bg border border-chatgpt-border dark:border-chatgpt-dark-border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none overflow-hidden text-gray-800 dark:text-gray-100 shadow-sm"
                        style="max-height: 200px;"
                    ></textarea>
                    <button
                        type="submit"
                        id="sendButton"
                        class="absolute right-3 p-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-600 text-white hover:from-blue-600 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
                    >
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>

                <div class="flex justify-center items-center mt-3 mb-2">
                    <span class="text-gray-600 dark:text-gray-300 mr-3">Search Mode</span>
                    <label for="aiToggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="aiToggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-gradient-to-r peer-checked:from-blue-500 peer-checked:to-purple-600"></div>
                    </label>
                    <span class="text-gray-600 dark:text-gray-300 ml-3">AI Assistant</span>
                </div>

                <div class="text-xs text-center text-gray-500 dark:text-gray-400 mt-3">
                    Brecker Search may produce inaccurate information about people, places, or facts.
                </div>
            </form>
        </div>
    </div>

    <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="relative">
            <button onclick="closeImageModal()" class="absolute -top-10 right-0 text-white text-3xl">×</button>
            <img id="modalImage" src="" alt="" class="max-w-full max-h-screen">
        </div>
    </div>

    <script>
        // Set dark mode based on system preference or saved setting
        if (localStorage.getItem('darkMode') === 'enabled' || (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }

        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('darkMode', 'disabled');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('darkMode', 'enabled');
            }
        }

        class BreckerSearchEngine {
            constructor() {
                this.messagesContainer = document.getElementById('messagesContainer');
                this.chatContainer = document.getElementById('chatContainer');
                this.searchForm = document.getElementById('searchForm');
                this.searchInput = document.getElementById('searchInput');
                this.sendButton = document.getElementById('sendButton');
                this.chatHistory = document.getElementById('chatHistory');
                this.storageInfo = document.getElementById('storageInfo');
                this.aiToggle = document.getElementById('aiToggle');

                this.conversations = this.loadConversations();
                this.currentConversationId = null;
                this.settings = this.loadSettings();

                this.initializeEventListeners();
                this.loadSidebar();
                this.updateStorageInfo();
                // Load the most recent conversation or create a new one
                if (this.conversations.length > 0) {
                    const lastConversation = this.conversations[this.conversations.length - 1];
                    this.switchConversation(lastConversation.id);
                } else {
                    this.startNewConversation();
                }
            }

            initializeEventListeners() {
                this.searchForm.addEventListener('submit', (e) => this.handleSubmit(e));
                this.searchInput.addEventListener('input', () => this.adjustTextareaHeight());
                this.searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.handleSubmit(e);
                    }
                });
            }

            adjustTextareaHeight() {
                this.searchInput.style.height = 'auto';
                this.searchInput.style.height = this.searchInput.scrollHeight + 'px';
            }

            setLoading(isLoading) {
                this.sendButton.disabled = isLoading;
                this.searchInput.disabled = isLoading;
                if (isLoading) {
                    this.sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                } else {
                    this.sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                }
            }

            async handleSubmit(e) {
                e.preventDefault();
                const query = this.searchInput.value.trim();
                if (!query) return;
                this.addUserMessage(query);
                this.searchInput.value = '';
                this.searchInput.style.height = 'auto';
                this.setLoading(true);

                const isAIEnabled = this.aiToggle.checked;

                try {
                    if (isAIEnabled) {
                        await this.performGeminiSearch(query);
                    } else {
                        await this.performAISearch(query);
                    }
                    this.saveCurrentConversation();
                } catch (error) {
                    console.error('Search/AI error:', error);
                    this.addAIMessage('I encountered an error. Please try again.', 'error');
                } finally {
                    this.setLoading(false);
                }
            }

            async performAISearch(query) {
                this.addTypingIndicator();
                try {
                    const searchType = this.detectSearchType(query);
                    let searchResults = '';

                    switch (searchType) {
                        case 'image':
                            searchResults = await this.searchImages(query);
                            break;
                        case 'video':
                            searchResults = await this.searchVideos(query);
                            break;
                        case 'web':
                        default:
                            searchResults = await this.searchWeb(query);
                            break;
                    }
                    this.removeTypingIndicator();
                    this.addAIMessage(searchResults);
                } catch (error) {
                    this.removeTypingIndicator();
                    throw error;
                }
            }

            async performGeminiSearch(query) {
                this.addTypingIndicator();
                try {
                    // WARNING: YOUR API KEY IS DIRECTLY EMBEDDED HERE.
                    // This is not secure for production applications.
                    // Consider using a backend proxy to protect your API key.
                    const API_KEY = "AIzaSyDH1pc85NSAmoP5YfsGsY2YR_6Ei0hptXw";
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`;

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: query }]
                            }]
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Gemini API error:', errorData);
                        throw new Error(`Gemini API error: ${JSON.stringify(errorData)}`);
                    }

                    const data = await response.json();
                    let geminiResponse = 'No response text found.';
                    if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                        geminiResponse = data.candidates[0].content.parts.map(part => part.text).join('');
                    }

                    this.removeTypingIndicator();
                    this.addAIMessage(`
                        <div class="font-semibold mb-2">AI Assistant Response:</div>
                        <div>${this.escapeHtml(geminiResponse)}</div>
                        <div class="mt-4 text-sm text-gray-500 dark:text-gray-400">
                            You can switch back to "Search Mode" for web, image, or video results.
                        </div>
                    `);
                } catch (error) {
                    console.error('Gemini API call error:', error);
                    this.removeTypingIndicator();
                    this.addAIMessage('Sorry, I could not get a response from the AI assistant. Please try again.', 'error');
                }
            }

            addTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'flex items-center text-gray-600 dark:text-gray-400 message-bubble ai-bubble typing-indicator-bubble';
                typingDiv.innerHTML = `
                    <div class="flex-shrink-0 mr-3">
                        <img src="https://assets-global.website-files.com/64b58e7033504a754160a2b9/64de85566113b19280d50041_logo.png" alt="Brecker Logo" class="h-8 w-8 rounded-full">
                    </div>
                    <div class="message-content p-3 rounded-xl bg-gray-200 dark:bg-chatgpt-dark-message-bg shadow-sm">
                        <div class="flex items-center">
                            Brecker is searching<span class="typing-indicator"></span><span class="typing-indicator"></span><span class="typing-indicator"></span>
                        </div>
                    </div>
                `;
                this.messagesContainer.appendChild(typingDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            removeTypingIndicator() {
                const typingIndicator = this.messagesContainer.querySelector('.typing-indicator-bubble');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            addUserMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex justify-end';
                messageDiv.innerHTML = `
                    <div class="message-bubble user-bubble bg-gradient-to-r from-blue-500 to-purple-600 text-white p-3 rounded-xl shadow-sm max-w-lg">
                        ${this.escapeHtml(message)}
                    </div>
                `;
                this.messagesContainer.appendChild(messageDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                this.addMessageToCurrentConversation('user', message);
            }

            addAIMessage(message, type = 'text') {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex';
                let contentHtml = '';

                if (type === 'image_results') {
                    contentHtml = `<div class="grid grid-cols-2 md:grid-cols-3 gap-4">${message}</div>`;
                } else if (type === 'video_results') {
                    contentHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${message}</div>`;
                } else {
                    contentHtml = `<div>${message}</div>`;
                }

                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 mr-3">
                        <img src="https://assets-global.website-files.com/64b58e7033504a754160a2b9/64de85566113b19280d50041_logo.png" alt="Brecker Logo" class="h-8 w-8 rounded-full">
                    </div>
                    <div class="message-content p-3 rounded-xl bg-gray-200 dark:bg-chatgpt-dark-message-bg shadow-sm max-w-full lg:max-w-3xl">
                        ${contentHtml}
                    </div>
                `;
                this.messagesContainer.appendChild(messageDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                this.addMessageToCurrentConversation('ai', message, type);
            }

            detectSearchType(query) {
                query = query.toLowerCase();
                if (query.includes('image of') || query.includes('show images of') || query.includes('images for')) {
                    return 'image';
                }
                if (query.includes('video of') || query.includes('show videos of') || query.includes('videos for') || query.includes('youtube')) {
                    return 'video';
                }
                return 'web';
            }

            // Dummy search functions (replace with actual API calls)
            async searchWeb(query) {
                // Placeholder for actual web search API call
                console.log(`Searching web for: ${query}`);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate API delay
                return `<p class="font-semibold mb-2">Web Search Results for "${this.escapeHtml(query)}":</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li><a href="https://example.com/result1" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline">Example Web Result 1: Learn about ${this.escapeHtml(query)}</a></li>
                            <li><a href="https://example.com/result2" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline">Example Web Result 2: History of ${this.escapeHtml(query)}</a></li>
                            <li><a href="https://example.com/result3" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline">Example Web Result 3: ${this.escapeHtml(query)} Best Practices</a></li>
                        </ul>
                        <div class="mt-4 text-sm text-gray-500 dark:text-gray-400">
                            (Note: These are dummy results. Integrate a real search API for live data.)
                        </div>`;
            }

            async searchImages(query) {
                // Placeholder for actual image search API call
                console.log(`Searching images for: ${query}`);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate API delay
                const images = [
                    { src: 'https://via.placeholder.com/150/0000FF/FFFFFF?text=Image+1', alt: `Result for ${query} 1` },
                    { src: 'https://via.placeholder.com/150/FF0000/FFFFFF?text=Image+2', alt: `Result for ${query} 2` },
                    { src: 'https://via.placeholder.com/150/00FF00/FFFFFF?text=Image+3', alt: `Result for ${query} 3` },
                    { src: 'https://via.placeholder.com/150/FFFF00/000000?text=Image+4', alt: `Result for ${query} 4` }
                ];
                let imageHtml = `<p class="font-semibold mb-2 col-span-full">Image Search Results for "${this.escapeHtml(query)}":</p>`;
                images.forEach((img, index) => {
                    imageHtml += `
                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer" onclick="openImageModal('${img.src}', '${this.escapeHtml(img.alt)}')">
                            <img src="${img.src}" alt="${this.escapeHtml(img.alt)}" class="w-full h-32 object-cover">
                            <p class="p-2 text-xs text-center text-gray-700 dark:text-gray-200 truncate">${this.escapeHtml(img.alt)}</p>
                        </div>
                    `;
                });
                imageHtml += `<div class="mt-4 text-sm text-gray-500 dark:text-gray-400 col-span-full">
                                (Note: These are dummy results. Integrate a real image search API for live data.)
                              </div>`;
                return imageHtml;
            }

            async searchVideos(query) {
                // Placeholder for actual video search API call
                console.log(`Searching videos for: ${query}`);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate API delay
                const videos = [
                    { title: `Video about ${query} 1`, url: 'https://www.youtube.com/embed/dQw4w9WgXcQ?si=abcdef', thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/hqdefault.jpg' },
                    { title: `Video about ${query} 2`, url: 'https://www.youtube.com/embed/other_video_id?si=ghijkl', thumbnail: 'https://img.youtube.com/vi/other_video_id/hqdefault.jpg' }
                ];
                let videoHtml = `<p class="font-semibold mb-2 col-span-full">Video Search Results for "${this.escapeHtml(query)}":</p>`;
                videos.forEach(video => {
                    videoHtml += `
                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden shadow-sm p-3">
                            <div class="aspect-w-16 aspect-h-9 mb-2">
                                <iframe class="w-full h-40 rounded" src="${video.url}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                            </div>
                            <p class="text-sm font-medium text-gray-800 dark:text-gray-100 truncate">${this.escapeHtml(video.title)}</p>
                            <a href="${video.url}" target="_blank" class="text-blue-600 dark:text-blue-400 text-xs hover:underline">Watch on YouTube</a>
                        </div>
                    `;
                });
                videoHtml += `<div class="mt-4 text-sm text-gray-500 dark:text-gray-400 col-span-full">
                                (Note: These are dummy results. Integrate a real video search API for live data.)
                              </div>`;
                return videoHtml;
            }

            // Conversation Management
            loadConversations() {
                const conversations = localStorage.getItem('breckerConversations');
                return conversations ? JSON.parse(conversations) : [];
            }

            saveConversations() {
                localStorage.setItem('breckerConversations', JSON.stringify(this.conversations));
                this.updateStorageInfo();
            }

            saveCurrentConversation() {
                const index = this.conversations.findIndex(conv => conv.id === this.currentConversationId);
                if (index !== -1) {
                    // Update existing conversation (already modified by addMessageToCurrentConversation)
                    this.conversations[index].lastUpdated = Date.now();
                } else {
                    // This should ideally not happen if currentConversationId is set correctly
                    console.warn("Attempted to save current conversation but ID not found.");
                }
                this.saveConversations();
                this.loadSidebar(); // Refresh sidebar to show updated timestamp/title
            }

            startNewConversation() {
                const newId = Date.now().toString();
                const newConversation = {
                    id: newId,
                    title: 'New Chat',
                    messages: [],
                    created: Date.now(),
                    lastUpdated: Date.now()
                };
                this.conversations.push(newConversation);
                this.currentConversationId = newId;
                this.messagesContainer.innerHTML = ''; // Clear chat area
                this.saveConversations();
                this.loadSidebar();
                this.updateChatHistoryActiveState();
            }

            switchConversation(id) {
                this.currentConversationId = id;
                const conversation = this.conversations.find(conv => conv.id === id);
                if (conversation) {
                    this.messagesContainer.innerHTML = '';
                    conversation.messages.forEach(msg => {
                        if (msg.sender === 'user') {
                            this.addUserMessage(msg.text);
                        } else {
                            this.addAIMessage(msg.text, msg.type);
                        }
                    });
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }
                this.updateChatHistoryActiveState();
            }

            deleteConversation(id, event) {
                event.stopPropagation(); // Prevent switching to the conversation
                this.showConfirmModal('Delete Chat', 'Are you sure you want to delete this chat?', () => {
                    this.conversations = this.conversations.filter(conv => conv.id !== id);
                    this.saveConversations();
                    this.loadSidebar();
                    if (this.currentConversationId === id) {
                        // If current chat is deleted, start new conversation
                        this.startNewConversation();
                    } else {
                        this.updateChatHistoryActiveState(); // Just update active state if not current
                    }
                    this.closeConfirmModal();
                });
            }

            clearAllConversations() {
                this.showConfirmModal('Clear All Chats', 'This will delete all your chats. Are you sure?', () => {
                    localStorage.removeItem('breckerConversations');
                    this.conversations = [];
                    this.currentConversationId = null;
                    this.messagesContainer.innerHTML = '';
                    this.startNewConversation(); // Start a new empty chat
                    this.saveConversations();
                    this.loadSidebar();
                    this.closeConfirmModal();
                });
            }

            exportConversations() {
                const dataStr = JSON.stringify(this.conversations, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `brecker_chats_export_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            importConversations(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData) && importedData.every(conv => conv.id && conv.messages)) {
                            this.showConfirmModal('Import Chats', 'This will replace your current chats. Are you sure?', () => {
                                this.conversations = importedData;
                                this.saveConversations();
                                this.loadSidebar();
                                if (this.conversations.length > 0) {
                                    this.switchConversation(this.conversations[0].id);
                                } else {
                                    this.startNewConversation();
                                }
                                this.closeConfirmModal();
                            });
                        } else {
                            alert('Invalid JSON file format. Please upload a valid Brecker chat export file.');
                        }
                    } catch (error) {
                        alert('Failed to parse JSON file. Please ensure it is a valid JSON.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            }

            addMessageToCurrentConversation(sender, text, type = 'text') {
                const conversation = this.conversations.find(conv => conv.id === this.currentConversationId);
                if (conversation) {
                    conversation.messages.push({ sender, text, type, timestamp: Date.now() });
                    // Update conversation title if it's still 'New Chat'
                    if (conversation.title === 'New Chat' && sender === 'user' && conversation.messages.length === 1) {
                        conversation.title = text.substring(0, 30) + (text.length > 30 ? '...' : '');
                    }
                }
            }

            loadSidebar() {
                this.chatHistory.innerHTML = '';
                // Sort conversations by last updated, newest first
                const sortedConversations = [...this.conversations].sort((a, b) => b.lastUpdated - a.lastUpdated);

                sortedConversations.forEach(conv => {
                    const chatItem = document.createElement('div');
                    chatItem.className = `flex justify-between items-center py-2 px-3 rounded-lg cursor-pointer text-gray-800 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-700 transition duration-200 group ${this.currentConversationId === conv.id ? 'bg-gray-300 dark:bg-gray-700' : ''}`;
                    chatItem.setAttribute('data-id', conv.id);
                    chatItem.onclick = () => this.switchConversation(conv.id);

                    const lastUpdated = new Date(conv.lastUpdated);
                    const now = new Date();
                    let displayDate;
                    if (lastUpdated.toDateString() === now.toDateString()) {
                        displayDate = `Today ${lastUpdated.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                    } else if (lastUpdated.getFullYear() === now.getFullYear() && lastUpdated.getMonth() === now.getMonth() && lastUpdated.getDate() === now.getDate() - 1) {
                        displayDate = `Yesterday ${lastUpdated.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                    } else {
                        displayDate = lastUpdated.toLocaleDateString();
                    }

                    chatItem.innerHTML = `
                        <div class="flex-1 overflow-hidden">
                            <div class="font-medium truncate">${this.escapeHtml(conv.title)}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${displayDate}</div>
                        </div>
                        <button class="ml-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation(); window.searchEngine.deleteConversation('${conv.id}', event);">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    this.chatHistory.appendChild(chatItem);
                });
            }

            updateChatHistoryActiveState() {
                document.querySelectorAll('#chatHistory div').forEach(item => {
                    if (item.getAttribute('data-id') === this.currentConversationId) {
                        item.classList.add('bg-gray-300', 'dark:bg-gray-700');
                    } else {
                        item.classList.remove('bg-gray-300', 'dark:bg-gray-700');
                    }
                });
            }

            updateStorageInfo() {
                const storageUsed = JSON.stringify(this.conversations).length; // Rough estimate in bytes
                const mbUsed = (storageUsed / (1024 * 1024)).toFixed(2);
                this.storageInfo.textContent = `Storage Used: ${mbUsed} MB`;
            }

            loadSettings() {
                const settings = localStorage.getItem('breckerSettings');
                return settings ? JSON.parse(settings) : {};
            }

            saveSettings(newSettings) {
                this.settings = { ...this.settings, ...newSettings };
                localStorage.setItem('breckerSettings', JSON.stringify(this.settings));
            }

            // Helper to escape HTML to prevent XSS
            escapeHtml(text) {
                const div = document.createElement('div');
                div.appendChild(document.createTextNode(text));
                return div.innerHTML;
            }

            showConfirmModal(title, message, onConfirm) {
                const modal = document.getElementById('confirmModal');
                document.getElementById('confirmModalTitle').textContent = title;
                document.getElementById('confirmModalMessage').textContent = message;
                const confirmButton = document.getElementById('confirmModalButton');
                confirmButton.onclick = onConfirm;
                modal.classList.remove('hidden');
            }

            closeConfirmModal() {
                const modal = document.getElementById('confirmModal');
                modal.classList.add('hidden');
            }
        }

        function openImageModal(url, title) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = url;
            modalImage.alt = title;
            modal.classList.remove('hidden');
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
        }

        function startNewChat() {
            window.searchEngine.startNewConversation();
        }

        function switchToConversation(id) {
            window.searchEngine.switchConversation(id);
        }

        function deleteConversation(id, event) {
            window.searchEngine.deleteConversation(id, event);
        }

        function clearAllConversations() {
            window.searchEngine.clearAllConversations();
        }

        function exportConversations() {
            window.searchEngine.exportConversations();
        }

        function importConversations(event) {
            window.searchEngine.importConversations(event);
        }

        function closeConfirmModal() {
            window.searchEngine.closeConfirmModal();
        }

        // Initialize Brecker Search Engine
        document.addEventListener('DOMContentLoaded', () => {
            window.searchEngine = new BreckerSearchEngine();
        });

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeImageModal();
                closeConfirmModal();
            }
        });
    </script>
</body>
</html>
